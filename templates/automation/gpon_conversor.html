{% extends "base.html" %}

<!-- Content -->
{% block content %}
<div
  class="d-flex justify-content-center align-items-center"
  style="height: 80vh"
>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-sm-10 col-md-6 col-lg-6 col-xl-5">
        <div class="card shadow p-4">
          <h5 class="card-title fw-bold mb-4">Conversor gpon</h5>

          <form>
            <div class="mb-3">
              <label for="file" class="form-label">Arquivo</label>
              <input type="file" class="form-control" id="file" name="file" />
            </div>

            <div class="d-flex mb-3 align-items-end">
              <div class="flex-grow-1 me-2">
                <label for="port" class="form-label">Porta</label>
                <input
                  type="text"
                  class="form-control"
                  id="port"
                  name="port"
                  placeholder="Ex: 1/1/1"
                />
              </div>

              <button id="startBtn" type="button" class="btn btn-dark">
                Converter
              </button>
            </div>
          </form>

          <div class="progress mt-3">
            <div
              id="progressBar"
              class="progress-bar"
              role="progressbar"
              style="width: 0%"
            >
              0%
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.getElementById("startBtn").onclick = function (e) {
    e.preventDefault();

    fetch("/start/")
      .then((r) => r.json())
      .then((data) => {
        pollProgress(data.task_id);
      });
  };

  function pollProgress(taskId) {
    const interval = setInterval(() => {
      fetch(`/progress/${taskId}/`)
        .then((r) => r.json())
        .then((data) => {
          const bar = document.getElementById("progressBar");

          bar.style.width = data.progress + "%";
          bar.innerText = data.progress + "%";

          if (data.progress >= 100) {
            clearInterval(interval);
          }
        });
    }, 1000);
  }
</script>
{% endblock %}
